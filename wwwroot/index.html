<html>

<body>
    <div style="width:40% ; float:left">
        <h1>Azure Web PubSub Chat</h1>
        <input id="message" placeholder="Type to chat...">
        <div id="messages"></div>
        <script>
            (async function () {
                let id = prompt('Please input your user name');
                let res = await fetch(`/negotiate?id=${id}`);
                let url = await res.text();
                debugger;
                let ws = new WebSocket(url);
                ws.onopen = () => console.log('connected');
                ws.onerror = (e, s, t) => { debugger; };
                ws.onclose = (e, s, t) => { debugger; };
                let messages = document.querySelector('#messages');
                let users = document.querySelector('#onlineUser');
                ws.onmessage = event => {
                    debugger;
                    var content = event.data.split('||');
                    let m = document.createElement('p');
                    let p = document.createElement('p');
                    m.innerText = content[0];
                    messages.appendChild(m);
                    if (content.length > 1) {
                        let record = JSON.parse(content[1]);
                        let keys = Object.keys(record);
                        let values = Object.values(record);
                        let htm = '<ul>';
                        for (i = 0; i < keys.length; i++) {
                            htm += '<li>';
                            htm += 'user id : <a>' + keys[i] + '</a>' + ': connection id :' + values[i];
                            htm += '</li>';
                        }
                        htm += '</ul>';
                        users.innerHTML = htm;
                    }
                };

                let message = document.querySelector('#message');
                message.addEventListener('keypress', e => {
                    if (e.charCode !== 13) return;
                    ws.send(message.value);
                    message.value = '';
                });
            })();
        </script>
    </div>
    <div style="width:40%; float:right">
        <h1>Online Users</h1>
        <div id="onlineUser"></div>
    </div>
</body>

</html>